#pragma once

#include "load_ini.h"

#define strcasecmp _stricmp 

void load_cfg(G_CONFIG* cfg)
{
    cfg->bit = 16;
    cfg->used_bit = 10;
    cfg->order = LITTLE_ENDIAN;
    cfg->pattern = BGGR;
    cfg->width = 1440;
    cfg->height = 1048;

    cfg->rgb_bit = 16;
    cfg->yuv_bit = 16;

    cfg->ob_on = 1;
    cfg->lsc_on = 1;
    cfg->gic_on = 1;
    cfg->isp_gain_on = 1;
    cfg->awb_on = 1;
    cfg->ltm_on = 0;
    cfg->ccm_on = 0;
    cfg->rgbgamma_on = 1;
    cfg->defog_on = 0;
    //cfg->ygamma_on = 0;
    cfg->sharp_on = 0;
    cfg->ynr_on = 1;
    cfg->cnr_on = 1;
    cfg->yuv_txi_on = 1;

    //12->16bit
    cfg->ob = 64 * 16;


    cfg->lsc_type = 0; //0为插值
    cfg->lsc_wblock = 17;
    cfg->lsc_hblock = 17;
    cfg->luma_str = 0.0;
    cfg->lsc_max_gain = 4096;
    cfg->lsc_gic_on = 1;
#if 1
    U16 lsc_tmpr[] = {
    3850,2531,2240,2065,1949,1860,1811,1759,1725,1703,1694,1693,1718,1788,2007,4125,5451,
    2766,2279,2058,1930,1833,1764,1723,1683,1662,1637,1617,1614,1615,1652,1740,2299,6594,
    2481,2108,1930,1814,1738,1692,1661,1629,1601,1582,1565,1555,1553,1561,1610,1821,4147,
    2267,1989,1836,1724,1662,1637,1610,1595,1567,1546,1520,1503,1489,1488,1525,1638,2643,
    2103,1897,1758,1652,1610,1584,1566,1552,1537,1520,1487,1461,1444,1439,1449,1528,2050,
    1992,1808,1681,1589,1563,1542,1528,1518,1499,1480,1454,1426,1395,1385,1395,1447,1729,
    1909,1734,1607,1523,1500,1500,1499,1481,1463,1436,1417,1388,1355,1332,1341,1375,1575,
    1846,1672,1551,1469,1460,1452,1457,1441,1425,1402,1379,1352,1319,1291,1286,1322,1483,
    1781,1620,1504,1431,1419,1414,1413,1398,1385,1366,1343,1313,1282,1258,1253,1279,1428,
    1724,1570,1458,1389,1377,1375,1374,1359,1347,1326,1305,1279,1246,1220,1219,1244,1386,
    1683,1531,1424,1355,1339,1333,1329,1324,1305,1288,1267,1247,1215,1191,1187,1215,1358,
    1655,1505,1397,1327,1305,1294,1284,1277,1260,1246,1225,1203,1182,1163,1157,1185,1372,
    1636,1482,1376,1300,1269,1256,1248,1231,1214,1201,1183,1165,1147,1135,1140,1170,1433,
    1641,1471,1360,1283,1233,1212,1198,1187,1168,1152,1141,1126,1113,1109,1122,1163,1609,
    1673,1474,1354,1273,1212,1176,1152,1136,1120,1111,1098,1088,1081,1079,1098,1179,2135,
    1757,1483,1355,1266,1206,1158,1121,1096,1081,1066,1059,1053,1052,1058,1097,1262,3191,
    2136,1540,1373,1274,1209,1158,1114,1082,1057,1040,1027,1024,1030,1062,1128,1593,3555
    };
    U16 lsc_tmpgr[] = {
    4466,2830,2447,2220,2044,1909,1833,1758,1714,1687,1677,1678,1713,1797,2032,4205,6185,
    3171,2532,2246,2060,1904,1772,1698,1635,1595,1572,1563,1565,1587,1644,1760,2339,7334,
    2825,2346,2092,1914,1765,1660,1584,1533,1492,1473,1465,1469,1497,1533,1611,1851,4341,
    2572,2229,1993,1798,1656,1565,1497,1453,1417,1395,1384,1394,1411,1448,1514,1670,2720,
    2398,2106,1902,1714,1583,1488,1420,1375,1351,1333,1317,1323,1343,1387,1442,1555,2109,
    2279,2016,1799,1632,1518,1424,1363,1319,1291,1273,1267,1269,1284,1322,1380,1473,1798,
    2183,1938,1727,1559,1452,1374,1314,1272,1246,1226,1222,1225,1241,1268,1327,1405,1644,
    2111,1872,1667,1507,1400,1325,1276,1235,1207,1190,1183,1186,1203,1230,1275,1356,1556,
    2048,1813,1614,1457,1364,1285,1232,1194,1172,1158,1151,1153,1167,1194,1241,1307,1500,
    1974,1752,1564,1416,1323,1253,1202,1166,1142,1130,1122,1125,1138,1163,1207,1271,1448,
    1927,1711,1528,1384,1294,1222,1174,1144,1121,1106,1101,1105,1115,1139,1175,1236,1417,
    1899,1675,1507,1357,1268,1201,1150,1123,1098,1087,1079,1081,1094,1117,1149,1204,1428,
    1875,1651,1479,1339,1251,1187,1139,1105,1082,1071,1065,1066,1076,1099,1130,1186,1480,
    1865,1641,1476,1338,1237,1170,1126,1095,1073,1059,1052,1052,1063,1081,1114,1182,1653,
    1901,1640,1475,1343,1234,1167,1117,1085,1063,1049,1041,1041,1050,1063,1098,1202,2199,
    1986,1649,1474,1347,1250,1176,1116,1082,1057,1042,1032,1030,1036,1055,1105,1284,3390,
    2440,1712,1497,1368,1275,1200,1136,1096,1066,1043,1027,1024,1036,1071,1145,1621,3888
    };
    U16 lsc_tmpgb[] = {
    4188,2706,2388,2165,2021,1898,1819,1753,1706,1681,1664,1659,1687,1761,1992,4145,5940,
    3003,2443,2188,2016,1867,1749,1676,1620,1579,1553,1539,1541,1559,1605,1706,2275,7057,
    2684,2250,2018,1858,1727,1637,1565,1510,1472,1448,1440,1444,1459,1490,1566,1787,4187,
    2437,2132,1916,1742,1617,1537,1474,1426,1390,1366,1355,1360,1378,1410,1464,1599,2628,
    2263,2013,1826,1656,1541,1459,1395,1352,1324,1305,1290,1292,1309,1340,1390,1486,2028,
    2157,1924,1733,1577,1474,1397,1337,1294,1264,1244,1237,1238,1249,1278,1327,1406,1716,
    2069,1847,1657,1507,1414,1344,1288,1249,1218,1197,1193,1193,1203,1227,1272,1343,1563,
    2001,1781,1597,1451,1362,1298,1246,1210,1183,1164,1156,1155,1165,1186,1224,1289,1473,
    1939,1719,1546,1411,1324,1258,1210,1173,1150,1134,1125,1123,1133,1155,1187,1245,1419,
    1868,1666,1503,1372,1292,1227,1181,1145,1123,1108,1099,1099,1106,1124,1158,1210,1374,
    1822,1631,1469,1339,1261,1201,1155,1125,1101,1085,1077,1077,1084,1099,1127,1180,1348,
    1797,1597,1444,1318,1241,1180,1134,1106,1083,1067,1058,1058,1065,1080,1104,1152,1366,
    1781,1573,1427,1303,1226,1168,1124,1092,1070,1055,1046,1044,1051,1065,1090,1137,1420,
    1772,1570,1423,1305,1213,1157,1115,1085,1062,1047,1038,1035,1039,1053,1079,1135,1595,
    1811,1580,1426,1316,1216,1155,1113,1080,1057,1042,1032,1030,1031,1041,1069,1159,2159,
    1901,1593,1433,1326,1240,1169,1116,1083,1059,1041,1028,1024,1026,1038,1079,1255,3334,
    2309,1664,1470,1351,1268,1204,1144,1104,1075,1050,1030,1024,1032,1061,1123,1585,3745
    };
    U16 lsc_tmpb[] = {
    4169,2664,2351,2185,2059,1958,1892,1838,1802,1761,1745,1740,1743,1803,2025,4406,7026,
    2922,2370,2166,2035,1942,1844,1800,1751,1728,1691,1671,1661,1651,1669,1745,2306,8192,
    2592,2208,2028,1907,1821,1776,1737,1695,1663,1640,1618,1604,1584,1583,1614,1809,4519,
    2359,2099,1934,1819,1752,1718,1691,1668,1635,1610,1573,1552,1531,1516,1528,1628,2676,
    2176,1978,1852,1750,1712,1668,1649,1618,1604,1578,1543,1511,1479,1461,1451,1512,2009,
    2071,1889,1763,1674,1651,1624,1617,1588,1562,1544,1514,1473,1430,1405,1394,1422,1685,
    1966,1801,1688,1610,1593,1585,1576,1556,1533,1506,1483,1439,1400,1354,1337,1353,1525,
    1892,1732,1626,1548,1541,1531,1535,1523,1504,1475,1443,1404,1358,1315,1282,1304,1433,
    1827,1680,1575,1504,1497,1493,1494,1478,1463,1445,1408,1370,1325,1276,1251,1253,1383,
    1769,1623,1516,1453,1448,1447,1448,1436,1427,1401,1373,1337,1287,1242,1217,1214,1333,
    1727,1583,1478,1413,1408,1403,1404,1398,1381,1360,1333,1301,1254,1211,1184,1183,1311,
    1687,1550,1452,1382,1363,1358,1352,1346,1332,1316,1290,1257,1218,1181,1148,1155,1321,
    1663,1518,1420,1352,1326,1315,1304,1292,1275,1263,1240,1212,1181,1149,1128,1137,1367,
    1663,1509,1406,1326,1284,1263,1254,1237,1223,1206,1185,1162,1139,1114,1101,1133,1523,
    1700,1501,1388,1310,1249,1215,1195,1178,1163,1151,1133,1115,1096,1076,1077,1142,2046,
    1781,1500,1370,1296,1238,1187,1148,1127,1112,1098,1085,1070,1057,1049,1071,1209,3368,
    2183,1550,1375,1282,1221,1170,1123,1090,1069,1051,1033,1024,1023,1038,1089,1505,3919
    };

#endif

    cfg->isp_gain = 1024 * 0.8;

    cfg->gic_str = 0.8;
    cfg->gic_thd = 1.25;
     
    cfg->r_gain = 1024 * 1.65;
    cfg->g_gain = 1024 * 1;
    cfg->b_gain = 1024 * 1.73;


    cfg->ltm_r = 20;
    cfg->ltm_str = 1.3;
    cfg->ltm_gain_limit_max = 2;
    cfg->ltm_gain_limit_min = 0.0;


    float ccm_tmp[9] = {
1.00, 	0.85, - 0.36,
0.60, - 0.73, 	1.02,
0.51, - 0.72, 	1.00
    };




    cfg->defog_smp_ratio = 4;
    cfg->light_ratio = 1.0;
    cfg->defog_str = 0.15;

    U32 gamma_xtmp[GAMMA_LENGTH] =
    {
        0,1,2,3,4,5,6,7,8,10,12,14,16,20,24,28,32,40,48,56,64,80,96,112,128,160,192,224,256,320,384,448,512,640,768,896,1024,1280,1536,1792,2048,2304,2560,2816,3072,3328,3584,3840,4095
    };

    U32 gamma_ytmp[GAMMA_LENGTH] =
    {
        0,6,11,17,22,28,33,39,44,55,66,77,88,109,130,150,170,210,248,286,323,393,460,525,586,702,809,909,1002,1172,1323,1461,1587,1810,2003,2173,2325,2589,2812,3010,3191,3355,3499,3624,3736,3836,3927,4012,4095
    };

    cfg->ynr_r = 1;
    cfg->cnr_r = 3;

    cfg->txi_r_detail = 1;
    cfg->txi_r_bifilter = 1;
    cfg->txi_str = 20;

    //以下后处理
    U16 lsc_blk = cfg->lsc_wblock * cfg->lsc_hblock;
    cfg->lsc_rgain = (U16*)malloc(sizeof(U16) * lsc_blk);
    cfg->lsc_bgain = (U16*)malloc(sizeof(U16) * lsc_blk);
    cfg->lsc_grgain = (U16*)malloc(sizeof(U16) * lsc_blk);
    cfg->lsc_gbgain = (U16*)malloc(sizeof(U16) * lsc_blk);

    memcpy(cfg->lsc_rgain, lsc_tmpr, sizeof(U16) * lsc_blk);
    memcpy(cfg->lsc_bgain, lsc_tmpb, sizeof(U16) * lsc_blk);
    memcpy(cfg->lsc_grgain, lsc_tmpgr, sizeof(U16) * lsc_blk);
    memcpy(cfg->lsc_gbgain, lsc_tmpgb, sizeof(U16) * lsc_blk);

    if (cfg->awb_on == 0)
    {
        cfg->r_gain = 1024;
        cfg->g_gain = 1024;
        cfg->b_gain = 1024;
    }
    if (cfg->ccm_on == 1)
    {
        memcpy(cfg->ccm, ccm_tmp, 9 * sizeof(float));
    }
    else 
    {
        // 如果不启用CCM，则设置为单位矩阵
        cfg->ccm[0] = 1.0f; cfg->ccm[1] = 0.0f; cfg->ccm[2] = 0.0f;
        cfg->ccm[3] = 0.0f; cfg->ccm[4] = 1.0f; cfg->ccm[5] = 0.0f;
        cfg->ccm[6] = 0.0f; cfg->ccm[7] = 0.0f; cfg->ccm[8] = 1.0f;
    }
    calc_NAI((float)cfg->r_gain / 1024, (float)cfg->g_gain / 1024,
        (float)cfg->b_gain / 1024, cfg->ccm);
   
    if (cfg->rgb_bit > 12)
    {
        U8 shift = cfg->rgb_bit - 12;
        for (int i = 0; i < GAMMA_LENGTH; i++)
        {
            cfg->gamma_x[i] = gamma_xtmp[i] << shift;
            cfg->gamma_y[i] = gamma_ytmp[i] << shift;
        }
    }
    else if (cfg->rgb_bit < 12)
    {
        U8 shift = 12 - cfg->rgb_bit;
        for (int i = 0; i < GAMMA_LENGTH; i++)
        {
            cfg->gamma_x[i] = gamma_xtmp[i] >> shift;
            cfg->gamma_y[i] = gamma_ytmp[i] >> shift;
        }
    }

    return;
}

void calc_NAI(float rg, float gg, float bg, float* ccm)
{
    float nai[3] = { 0 };

  

    // 增益平方
    float gains[3] = {
        rg * rg,
        gg * gg,
        bg * bg
    };

    // 计算每个输出通道的NAI
    for (int out_c = 0; out_c < 3; ++out_c) {
        for (int in_c = 0; in_c < 3; ++in_c) {
            float coeff = ccm[out_c * 3 + in_c];  // 行主序访问
            nai[out_c] += coeff * coeff * gains[in_c];
        }
    }

    LOG("NAI = [%.2f, %.2f, %.2f]\n", nai[0], nai[1], nai[2]);
}

// 从 INI 文件加载配置
void load_cfg_from_ini(const char* filename, G_CONFIG* cfg) {
    FILE* f = fopen(filename, "r");
    if (!f) {
        perror("fopen");
        return;
    }
    // 初始化默认值
    memset(cfg, 0, sizeof(*cfg));
    cfg->order = LITTLE_ENDIAN;
    cfg->pattern = BGGR;
    cfg->lsc_rgain = NULL;

    char line[256], section[64] = { 0 };
    while (fgets(line, sizeof(line), f)) {
        char* p = trim(line);
        if (*p == 0 || *p == ';') continue;
        if (*p == '[') {
            char* end = strchr(p, ']');
            if (end) {
                size_t len = end - p - 1;
                strncpy(section, p + 1, len);
                section[len] = '\0';
            }
            continue;
        }
        char* eq = strchr(p, '=');
        if (!eq) continue;
        *eq = '\0';
        char* key = trim(p), * val = trim(eq + 1);

        if (strcmp(section, "raw_param") == 0) {
            if (strcmp(key, "bit") == 0) cfg->bit = (U8)strtoul(val, NULL, 0);
            else if (strcmp(key, "used_bit") == 0) cfg->used_bit = (U8)strtoul(val, NULL, 0);
            else if (strcmp(key, "order") == 0) cfg->order = parse_order(val);
            else if (strcmp(key, "pattern") == 0) cfg->pattern = parse_pattern(val);
        }
        else if (strcmp(section, "module_on") == 0) {
            if (strcmp(key, "ob_on") == 0) cfg->ob_on = (U8)strtoul(val, NULL, 0);
            else if (strcmp(key, "lsc_on") == 0) cfg->lsc_on = (U8)strtoul(val, NULL, 0);
        }
        else if (strcmp(section, "ob") == 0) {
            if (strcmp(key, "ob") == 0) cfg->ob = (U16)(eval_simple_expr(val) + 0.5);
        }
        else if (strcmp(section, "lsc") == 0) {
            if (strcmp(key, "lsc_rgain") == 0) parse_u16_array(val, &cfg->lsc_rgain);
        }
        else if (strcmp(section, "awb") == 0) {
            if (strcmp(key, "r_gain") == 0) cfg->r_gain = (U16)(eval_simple_expr(val) + 0.5);
        }
        else if (strcmp(section, "ccm") == 0) {
            if (strcmp(key, "ccm") == 0) parse_float_array9(val, cfg->ccm);
        }
    }
    fclose(f);
}

// 去除首尾空白
static char* trim(char* s) {
    char* end;
    while (isspace((unsigned char)*s)) s++;
    if (*s == 0) return s;
    end = s + strlen(s) - 1;
    while (end > s && isspace((unsigned char)*end)) end--;
    *(end + 1) = 0;
    return s;
}

// 解析字节顺序
static ByteOrder parse_order(const char* s) {
    return (strcasecmp(s, "BIG_ENDIAN") == 0) ? BIG_ENDIAN : LITTLE_ENDIAN;
}

// 解析 Bayer 格式
static BayerPattern parse_pattern(const char* s) {
    if (strcasecmp(s, "RGGB") == 0) return RGGB;
    else if (strcasecmp(s, "GRBG") == 0) return GRBG;
    else if (strcasecmp(s, "GBRG") == 0) return GBRG;
    else                                   return BGGR;
}

// 计算简单表达式：支持 a 或 a*b
static double eval_simple_expr(const char* s) {
    char* star = (char*)malloc(strlen(s) + 1);
    strcpy(star, s);
    if (!star) {
        return strtod(s, NULL);
    }
    else {
        double a = strtod(s, NULL);
        double b = strtod(star + 1, NULL);
        return a * b;
    }
}

// 解析 U16 数组，返回元素个数
static int parse_u16_array(const char* s, U16** out) {
    // 定位到 '[' 并跳过
    while (*s && *s != '[') s++;
    if (*s == '[') s++;
    size_t cap = 4, cnt = 0;
    U16* arr = (U16*)malloc(cap * sizeof(U16));
    char* copy = strdup(s);
    char* rb = strchr(copy, ']');
    if (rb) *rb = '\0';

    char* tok = strtok(copy, ",");
    while (tok) {
        double v = eval_simple_expr(trim(tok));
        if (cnt >= cap) {
            cap *= 2;
            arr = (U16*)realloc(arr, cap * sizeof(U16));
        }
        arr[cnt++] = (U16)(v + 0.5);
        tok = strtok(NULL, ",");
    }

    free(copy);
    *out = arr;
    return (int)cnt;
}

// 解析 9 元素 float 数组
static void parse_float_array9(const char* s, float out[9]) {
    while (*s && *s != '[') s++;
    if (*s == '[') s++;
    char* copy = strdup(s);
    char* rb = strchr(copy, ']');
    if (rb) *rb = '\0';

    int idx = 0;
    char* tok = strtok(copy, ",");
    while (tok && idx < 9) {
        out[idx++] = (float)eval_simple_expr(trim(tok));
        tok = strtok(NULL, ",");
    }

    free(copy);
}
