#pragma once

#include "load_ini.h"

#define strcasecmp _stricmp 

void load_cfg(G_CONFIG* cfg)
{
	cfg->bit = 16;
	cfg->used_bit = 10;
	cfg->order = LITTLE_ENDIAN;
	cfg->pattern = GBRG;
	cfg->width = 720;
	cfg->height = 720; 

	cfg->rgb_bit = 16;
	cfg->yuv_bit = 16;

	cfg->ob_on = 1;
	cfg->lsc_on = 1;
	cfg->isp_gain_on = 0;
	cfg->gic_on = 1;
	cfg->awb_on = 1;
	cfg->ltm_on = 0;
	cfg->ccm_on = 1; 
	cfg->rgbgamma_on = 1;
	cfg->defog_on = 0;
	//cfg->ygamma_on = 0;
	cfg->sharp_on = 0;
	cfg->ynr_on = 1;
	cfg->cnr_on = 1;
    cfg->yuv_txi_on = 0;

	//12->16bit
	cfg->ob = 0 * 16;


    cfg->lsc_type = 0; //0为插值
    cfg->lsc_wblock = 17;
    cfg->lsc_hblock = 17;
    cfg->luma_str = 0.0;
    cfg->lsc_max_gain = 4096;
    cfg->lsc_gic_on = 1;
#if 1
	U16 lsc_tmpr[] = {
	1344,1317,1271,1244,1222,1203,1198,1192,1187,1198,1196,1208,1221,1257,1281,1303,1381,
	1293,1248,1217,1201,1178,1164,1152,1149,1149,1160,1162,1172,1184,1213,1238,1273,1320,
	1251,1218,1193,1168,1144,1134,1124,1116,1112,1124,1132,1138,1162,1184,1211,1247,1290,
	1220,1185,1156,1137,1114,1103,1099,1091,1088,1094,1098,1121,1133,1161,1189,1223,1272,
	1194,1167,1139,1115,1095,1080,1071,1065,1070,1072,1079,1100,1116,1140,1169,1203,1248,
	1183,1153,1121,1104,1080,1074,1057,1056,1051,1055,1058,1073,1098,1122,1153,1183,1230,
	1174,1147,1114,1088,1071,1056,1044,1045,1039,1043,1054,1064,1084,1106,1141,1169,1213,
	1167,1132,1107,1083,1068,1050,1039,1031,1028,1034,1040,1056,1073,1098,1128,1161,1202,
	1161,1126,1102,1079,1057,1045,1037,1037,1024,1024,1040,1054,1069,1089,1117,1156,1194,
	1154,1125,1100,1077,1061,1041,1036,1028,1026,1024,1034,1044,1066,1091,1112,1147,1189,
	1154,1126,1099,1075,1056,1045,1037,1032,1028,1029,1040,1051,1071,1090,1111,1151,1194,
	1161,1133,1103,1079,1062,1047,1036,1033,1034,1033,1044,1058,1072,1090,1114,1156,1196,
	1172,1143,1111,1082,1067,1059,1052,1043,1039,1047,1053,1071,1078,1104,1127,1163,1200,
	1183,1154,1121,1096,1085,1069,1061,1055,1051,1058,1066,1081,1096,1112,1141,1173,1208,
	1197,1169,1138,1116,1101,1084,1074,1071,1073,1079,1082,1098,1109,1138,1163,1186,1226,
	1209,1189,1159,1136,1121,1107,1097,1091,1095,1101,1105,1119,1137,1159,1186,1215,1242,
	1241,1220,1195,1178,1161,1149,1139,1143,1143,1143,1161,1170,1182,1210,1229,1259,1296
	};
	U16 lsc_tmpgr[] = {
	1059,1053,1042,1043,1042,1040,1042,1046,1045,1051,1051,1053,1061,1074,1076,1082,1111,
	1044,1039,1033,1038,1034,1036,1037,1037,1045,1047,1048,1051,1056,1068,1077,1084,1096,
	1035,1033,1031,1033,1032,1033,1037,1038,1036,1043,1048,1047,1057,1067,1076,1082,1097,
	1027,1025,1027,1027,1025,1027,1031,1032,1036,1038,1041,1047,1055,1066,1071,1082,1097,
	1027,1027,1027,1026,1026,1026,1028,1027,1032,1037,1039,1049,1056,1064,1073,1078,1093,
	1028,1026,1026,1027,1024,1028,1025,1028,1027,1034,1036,1045,1053,1061,1072,1074,1089,
	1027,1026,1027,1024,1025,1025,1025,1024,1026,1030,1035,1043,1052,1061,1069,1075,1090,
	1027,1025,1026,1024,1025,1025,1025,1024,1025,1027,1034,1042,1049,1058,1066,1070,1087,
	1025,1024,1026,1026,1024,1025,1024,1026,1024,1027,1033,1041,1048,1055,1060,1069,1082,
	1024,1025,1026,1025,1024,1024,1024,1025,1024,1026,1033,1035,1048,1054,1058,1063,1078,
	1026,1027,1024,1025,1024,1025,1025,1025,1024,1026,1034,1040,1050,1054,1058,1063,1078,
	1026,1024,1025,1026,1024,1024,1024,1024,1025,1026,1033,1040,1049,1051,1056,1064,1075,
	1027,1026,1025,1024,1024,1024,1025,1024,1025,1031,1037,1044,1049,1057,1057,1064,1073,
	1025,1024,1024,1026,1026,1024,1026,1026,1026,1032,1039,1044,1050,1053,1057,1062,1070,
	1027,1025,1024,1025,1026,1025,1025,1024,1029,1036,1041,1045,1051,1056,1063,1065,1070,
	1024,1024,1026,1025,1027,1024,1025,1028,1034,1041,1044,1050,1055,1060,1066,1067,1070,
	1032,1030,1030,1033,1033,1035,1038,1045,1050,1056,1061,1066,1069,1075,1078,1078,1085
	};
	U16 lsc_tmpgb[] = {
	1059,1053,1042,1043,1042,1040,1042,1046,1045,1051,1051,1053,1061,1074,1076,1082,1111,
	1044,1039,1033,1038,1034,1036,1037,1037,1045,1047,1048,1051,1056,1068,1077,1084,1096,
	1035,1033,1031,1033,1032,1033,1037,1038,1036,1043,1048,1047,1057,1067,1076,1082,1097,
	1027,1025,1027,1027,1025,1027,1031,1032,1036,1038,1041,1047,1055,1066,1071,1082,1097,
	1027,1027,1027,1026,1026,1026,1028,1027,1032,1037,1039,1049,1056,1064,1073,1078,1093,
	1028,1026,1026,1027,1024,1028,1025,1028,1027,1034,1036,1045,1053,1061,1072,1074,1089,
	1027,1026,1027,1024,1025,1025,1025,1024,1026,1030,1035,1043,1052,1061,1069,1075,1090,
	1027,1025,1026,1024,1025,1025,1025,1024,1025,1027,1034,1042,1049,1058,1066,1070,1087,
	1025,1024,1026,1026,1024,1025,1024,1026,1024,1027,1033,1041,1048,1055,1060,1069,1082,
	1024,1025,1026,1025,1024,1024,1024,1025,1024,1026,1033,1035,1048,1054,1058,1063,1078,
	1026,1027,1024,1025,1024,1025,1025,1025,1024,1026,1034,1040,1050,1054,1058,1063,1078,
	1026,1024,1025,1026,1024,1024,1024,1024,1025,1026,1033,1040,1049,1051,1056,1064,1075,
	1027,1026,1025,1024,1024,1024,1025,1024,1025,1031,1037,1044,1049,1057,1057,1064,1073,
	1025,1024,1024,1026,1026,1024,1026,1026,1026,1032,1039,1044,1050,1053,1057,1062,1070,
	1027,1025,1024,1025,1026,1025,1025,1024,1029,1036,1041,1045,1051,1056,1063,1065,1070,
	1024,1024,1026,1025,1027,1024,1025,1028,1034,1041,1044,1050,1055,1060,1066,1067,1070,
	1032,1030,1030,1033,1033,1035,1038,1045,1050,1056,1061,1066,1069,1075,1078,1078,1085
	};
	U16 lsc_tmpb[] = {
	1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,
	1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,
	1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,
	1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,
	1025,1028,1028,1029,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,
	1035,1029,1028,1030,1028,1029,1026,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,
	1033,1035,1037,1030,1028,1028,1024,1025,1024,1024,1024,1024,1024,1024,1024,1024,1024,
	1035,1034,1036,1032,1031,1027,1029,1026,1024,1024,1024,1024,1024,1024,1024,1024,1024,
	1034,1033,1037,1035,1031,1033,1030,1029,1024,1024,1024,1024,1024,1024,1024,1024,1024,
	1030,1034,1037,1037,1038,1030,1031,1030,1024,1024,1024,1024,1024,1024,1024,1024,1024,
	1034,1042,1040,1036,1036,1032,1034,1031,1024,1024,1024,1024,1024,1024,1024,1024,1024,
	1038,1037,1037,1037,1034,1035,1033,1031,1025,1024,1024,1024,1024,1024,1024,1024,1024,
	1044,1042,1037,1029,1033,1035,1032,1029,1024,1024,1024,1024,1024,1024,1024,1024,1024,
	1040,1039,1037,1033,1034,1030,1027,1030,1024,1024,1024,1024,1024,1024,1024,1024,1024,
	1051,1042,1035,1033,1036,1034,1028,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,
	1051,1043,1035,1037,1032,1026,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,
	1051,1034,1029,1028,1026,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024
	};

#endif

    cfg->isp_gain = 1024 * 1.07;

    cfg->r_gain = 1024 * 1.87;
    cfg->g_gain = 1024 * 1;
    cfg->b_gain = 1024 * 1.02;


	cfg->ltm_r = 20;
	cfg->ltm_str = 1.3;
	cfg->ltm_gain_limit_max = 2;
	cfg->ltm_gain_limit_min = 0.0;


	float ccm_tmp[9] = {
1.02, -0.08, 0.08,
-0.11, 1.29, -0.21,
0.09, -0.21, 1.13


	};

    cfg->defog_smp_ratio = 4;
    cfg->light_ratio = 1.0;
    cfg->defog_str = 0.15;

    U32 gamma_xtmp[GAMMA_LENGTH] =
    {
        0,1,2,3,4,5,6,7,8,10,12,14,16,20,24,28,32,40,48,56,64,80,96,112,128,160,192,224,256,320,384,448,512,640,768,896,1024,1280,1536,1792,2048,2304,2560,2816,3072,3328,3584,3840,4095
    };

	U32 gamma_ytmp[GAMMA_LENGTH] =
	{
	0,6,11,17,22,28,33,39,44,55,66,77,88,109,130,150,170,210,248,286,323,393,460,525,586,702,809,909,1002,1172,1323,1461,1587,1810,2003,2173,2325,2589,2812,3010,3191,3355,3499,3624,3736,3836,3927,4012,4095
	};

	cfg->ynr_r = 1;
	cfg->cnr_r = 3;

	cfg->txi_r_detail = 1;
	cfg->txi_r_bifilter = 1;
	cfg->txi_str = 5;

	//以下后处理
	U16 lsc_blk = cfg->lsc_wblock * cfg->lsc_hblock;
	cfg->lsc_rgain = (U16*)malloc(sizeof(U16) * lsc_blk);
	cfg->lsc_bgain = (U16*)malloc(sizeof(U16) * lsc_blk);
	cfg->lsc_grgain = (U16*)malloc(sizeof(U16) * lsc_blk);
	cfg->lsc_gbgain = (U16*)malloc(sizeof(U16) * lsc_blk);

	memcpy(cfg->lsc_rgain, lsc_tmpr, sizeof(U16) * lsc_blk);
	memcpy(cfg->lsc_bgain, lsc_tmpb, sizeof(U16) * lsc_blk);
	memcpy(cfg->lsc_grgain, lsc_tmpgr, sizeof(U16) * lsc_blk);
	memcpy(cfg->lsc_gbgain, lsc_tmpgb, sizeof(U16) * lsc_blk);

    if (cfg->awb_on == 0)
    {
        cfg->r_gain = 1024;
        cfg->g_gain = 1024;
        cfg->b_gain = 1024;
    }
    if (cfg->ccm_on == 1)
    {
        memcpy(cfg->ccm, ccm_tmp, 9 * sizeof(float));
    }
    else 
    {
        // 如果不启用CCM，则设置为单位矩阵
        cfg->ccm[0] = 1.0f; cfg->ccm[1] = 0.0f; cfg->ccm[2] = 0.0f;
        cfg->ccm[3] = 0.0f; cfg->ccm[4] = 1.0f; cfg->ccm[5] = 0.0f;
        cfg->ccm[6] = 0.0f; cfg->ccm[7] = 0.0f; cfg->ccm[8] = 1.0f;
    }
    calc_NAI((float)cfg->r_gain / 1024, (float)cfg->g_gain / 1024,
        (float)cfg->b_gain / 1024, cfg->ccm);
   
    if (cfg->rgb_bit > 12)
    {
        U8 shift = cfg->rgb_bit - 12;
        for (int i = 0; i < GAMMA_LENGTH; i++)
        {
            cfg->gamma_x[i] = gamma_xtmp[i] << shift;
            cfg->gamma_y[i] = gamma_ytmp[i] << shift;
        }
    }
    else if (cfg->rgb_bit < 12)
    {
        U8 shift = 12 - cfg->rgb_bit;
        for (int i = 0; i < GAMMA_LENGTH; i++)
        {
            cfg->gamma_x[i] = gamma_xtmp[i] >> shift;
            cfg->gamma_y[i] = gamma_ytmp[i] >> shift;
        }
    }

	return;
}

void calc_NAI(float rg, float gg, float bg, float* ccm)
{
    float nai[3] = { 0 };

  

    // 增益平方
    float gains[3] = {
        rg * rg,
        gg * gg,
        bg * bg
    };

    // 计算每个输出通道的NAI
    for (int out_c = 0; out_c < 3; ++out_c) {
        for (int in_c = 0; in_c < 3; ++in_c) {
            float coeff = ccm[out_c * 3 + in_c];  // 行主序访问
            nai[out_c] += coeff * coeff * gains[in_c];
        }
    }

    LOG("NAI = [%.2f, %.2f, %.2f]\n", nai[0], nai[1], nai[2]);
}

// 从 INI 文件加载配置
void load_cfg_from_ini(const char* filename, G_CONFIG* cfg) {
	FILE* f = fopen(filename, "r");
	if (!f) {
		perror("fopen");
		return;
	}
	// 初始化默认值
	memset(cfg, 0, sizeof(*cfg));
	cfg->order = LITTLE_ENDIAN;
	cfg->pattern = BGGR;
	cfg->lsc_rgain = NULL;

	char line[256], section[64] = { 0 };
	while (fgets(line, sizeof(line), f)) {
		char* p = trim(line);
		if (*p == 0 || *p == ';') continue;
		if (*p == '[') {
			char* end = strchr(p, ']');
			if (end) {
				size_t len = end - p - 1;
				strncpy(section, p + 1, len);
				section[len] = '\0';
			}
			continue;
		}
		char* eq = strchr(p, '=');
		if (!eq) continue;
		*eq = '\0';
		char* key = trim(p), * val = trim(eq + 1);

		if (strcmp(section, "raw_param") == 0) {
			if (strcmp(key, "bit") == 0) cfg->bit = (U8)strtoul(val, NULL, 0);
			else if (strcmp(key, "used_bit") == 0) cfg->used_bit = (U8)strtoul(val, NULL, 0);
			else if (strcmp(key, "order") == 0) cfg->order = parse_order(val);
			else if (strcmp(key, "pattern") == 0) cfg->pattern = parse_pattern(val);
		}
		else if (strcmp(section, "module_on") == 0) {
			if (strcmp(key, "ob_on") == 0) cfg->ob_on = (U8)strtoul(val, NULL, 0);
			else if (strcmp(key, "lsc_on") == 0) cfg->lsc_on = (U8)strtoul(val, NULL, 0);
		}
		else if (strcmp(section, "ob") == 0) {
			if (strcmp(key, "ob") == 0) cfg->ob = (U16)(eval_simple_expr(val) + 0.5);
		}
		else if (strcmp(section, "lsc") == 0) {
			if (strcmp(key, "lsc_rgain") == 0) parse_u16_array(val, &cfg->lsc_rgain);
		}
		else if (strcmp(section, "awb") == 0) {
			if (strcmp(key, "r_gain") == 0) cfg->r_gain = (U16)(eval_simple_expr(val) + 0.5);
		}
		else if (strcmp(section, "ccm") == 0) {
			if (strcmp(key, "ccm") == 0) parse_float_array9(val, cfg->ccm);
		}
	}
	fclose(f);
}

// 去除首尾空白
static char* trim(char* s) {
	char* end;
	while (isspace((unsigned char)*s)) s++;
	if (*s == 0) return s;
	end = s + strlen(s) - 1;
	while (end > s && isspace((unsigned char)*end)) end--;
	*(end + 1) = 0;
	return s;
}

// 解析字节顺序
static ByteOrder parse_order(const char* s) {
	return (strcasecmp(s, "BIG_ENDIAN") == 0) ? BIG_ENDIAN : LITTLE_ENDIAN;
}

// 解析 Bayer 格式
static BayerPattern parse_pattern(const char* s) {
	if (strcasecmp(s, "RGGB") == 0) return RGGB;
	else if (strcasecmp(s, "GRBG") == 0) return GRBG;
	else if (strcasecmp(s, "GBRG") == 0) return GBRG;
	else   return BGGR;
}

// 计算简单表达式：支持 a 或 a*b
static double eval_simple_expr(const char* s) {
	char* star = (char*)malloc(strlen(s) + 1);
	strcpy(star, s);
	if (!star) {
		return strtod(s, NULL);
	}
	else {
		double a = strtod(s, NULL);
		double b = strtod(star + 1, NULL);
		return a * b;
	}
}

// 解析 U16 数组，返回元素个数
static int parse_u16_array(const char* s, U16** out) {
	// 定位到 '[' 并跳过
	while (*s && *s != '[') s++;
	if (*s == '[') s++;
	size_t cap = 4, cnt = 0;
	U16* arr = (U16*)malloc(cap * sizeof(U16));
	char* copy = strdup(s);
	char* rb = strchr(copy, ']');
	if (rb) *rb = '\0';

	char* tok = strtok(copy, ",");
	while (tok) {
		double v = eval_simple_expr(trim(tok));
		if (cnt >= cap) {
			cap *= 2;
			arr = (U16*)realloc(arr, cap * sizeof(U16));
		}
		arr[cnt++] = (U16)(v + 0.5);
		tok = strtok(NULL, ",");
	}

	free(copy);
	*out = arr;
	return (int)cnt;
}

// 解析 9 元素 float 数组
static void parse_float_array9(const char* s, float out[9]) {
	while (*s && *s != '[') s++;
	if (*s == '[') s++;
	char* copy = strdup(s);
	char* rb = strchr(copy, ']');
	if (rb) *rb = '\0';

	int idx = 0;
	char* tok = strtok(copy, ",");
	while (tok && idx < 9) {
		out[idx++] = (float)eval_simple_expr(trim(tok));
		tok = strtok(NULL, ",");
	}

	free(copy);
}
