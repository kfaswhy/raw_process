#pragma once

#include "load_ini.h"

#define strcasecmp _stricmp 

void load_cfg(G_CONFIG* cfg)
{
    cfg->bit = 16;
    cfg->used_bit = 10;
    cfg->order = LITTLE_ENDIAN;
    cfg->pattern = BGGR;
    cfg->width = 1440;
    cfg->height = 1048;

    cfg->rgb_bit = 16;
    cfg->yuv_bit = 16;

    cfg->ob_on = 1;
    cfg->lsc_on = 1;
    cfg->gic_on = 1;
    cfg->isp_gain_on = 0;
    cfg->awb_on = 1;
    cfg->ltm_on = 0;
    cfg->ccm_on = 1;
    cfg->rgbgamma_on = 1;
    cfg->defog_on = 0;
    //cfg->ygamma_on = 0;
    cfg->sharp_on = 0;
    cfg->ynr_on = 1;
    cfg->cnr_on = 1;
    cfg->yuv_txi_on = 1;

    //12->16bit
    cfg->ob = 64 * 16;


    cfg->lsc_type = 0; //0为插值
    cfg->lsc_wblock = 17;
    cfg->lsc_hblock = 17;
    cfg->luma_str = 0.3;
    cfg->lsc_max_gain = 4096;
    cfg->lsc_gic_on = 1;
#if 1
    U16 lsc_tmpr[] = {
    4096,3284,2848,2586,2411,2278,2204,2125,2070,2036,2020,2017,2056,2162,2496,4096,4096,
    3637,2907,2575,2384,2238,2130,2058,1992,1954,1917,1887,1886,1893,1951,2088,2931,4096,
    3209,2650,2383,2209,2093,2010,1948,1892,1845,1815,1791,1781,1784,1805,1889,2211,4096,
    2889,2471,2242,2074,1968,1910,1856,1820,1774,1739,1706,1690,1681,1692,1754,1932,3450,
    2642,2334,2125,1967,1880,1821,1774,1742,1711,1683,1641,1613,1601,1609,1640,1765,2552,
    2476,2201,2009,1867,1801,1749,1708,1677,1642,1611,1580,1549,1521,1522,1554,1643,2069,
    2351,2089,1899,1767,1707,1678,1652,1616,1580,1539,1517,1487,1456,1443,1472,1539,1833,
    2257,1996,1815,1686,1642,1605,1587,1552,1520,1487,1458,1428,1400,1380,1391,1458,1694,
    2159,1918,1744,1628,1580,1546,1523,1488,1461,1432,1404,1372,1343,1329,1339,1392,1613,
    2074,1844,1675,1565,1520,1489,1466,1432,1407,1378,1350,1322,1292,1274,1289,1339,1547,
    2013,1785,1625,1514,1466,1432,1405,1383,1351,1324,1297,1277,1248,1232,1242,1296,1507,
    1971,1746,1584,1476,1419,1379,1348,1325,1295,1271,1246,1223,1205,1193,1199,1252,1527,
    1942,1711,1553,1439,1373,1334,1303,1270,1240,1219,1196,1176,1161,1158,1174,1227,1614,
    1949,1695,1528,1412,1329,1282,1248,1220,1189,1165,1149,1133,1121,1124,1151,1220,1873,
    1997,1699,1519,1398,1306,1243,1197,1167,1137,1121,1102,1091,1085,1088,1121,1240,2669,
    2124,1713,1521,1388,1298,1225,1167,1126,1098,1074,1061,1053,1054,1066,1120,1358,4096,
    2692,1798,1548,1400,1301,1225,1160,1111,1074,1048,1029,1024,1030,1070,1162,1848,4096
    };
    U16 lsc_tmpgr[] = {
    4096,3592,3075,2746,2514,2331,2223,2120,2052,2013,1992,1989,2035,2151,2502,4096,4096,
    4059,3174,2775,2518,2302,2126,2016,1927,1867,1830,1810,1814,1844,1919,2080,2941,4096,
    3563,2889,2538,2297,2102,1958,1848,1768,1708,1676,1662,1669,1698,1748,1864,2208,4096,
    3192,2710,2387,2130,1937,1810,1712,1643,1588,1554,1537,1548,1574,1625,1713,1928,3490,
    2928,2534,2254,2007,1825,1694,1595,1530,1489,1461,1438,1444,1470,1524,1603,1757,2575,
    2757,2398,2111,1886,1725,1599,1509,1443,1399,1370,1360,1362,1381,1430,1508,1635,2102,
    2618,2280,2000,1780,1631,1521,1435,1375,1331,1299,1293,1295,1313,1352,1427,1538,1867,
    2514,2181,1910,1698,1554,1450,1374,1317,1275,1248,1236,1237,1257,1292,1352,1458,1730,
    2417,2091,1832,1632,1496,1391,1316,1260,1225,1202,1190,1189,1205,1241,1298,1389,1649,
    2312,2008,1762,1571,1443,1343,1272,1217,1183,1163,1149,1150,1164,1195,1251,1336,1576,
    2243,1948,1711,1522,1398,1301,1231,1185,1151,1126,1115,1118,1130,1158,1204,1288,1534,
    2201,1898,1674,1488,1365,1270,1199,1156,1121,1100,1087,1087,1101,1127,1167,1245,1555,
    2170,1861,1640,1463,1341,1250,1182,1133,1099,1079,1067,1065,1077,1103,1144,1219,1633,
    2160,1850,1629,1454,1321,1231,1167,1120,1087,1065,1052,1050,1059,1082,1125,1215,1891,
    2216,1856,1628,1460,1321,1228,1159,1112,1076,1056,1041,1039,1045,1061,1107,1242,2724,
    2350,1873,1631,1466,1340,1240,1162,1112,1074,1050,1032,1027,1033,1055,1116,1366,4096,
    2993,1971,1673,1494,1368,1272,1187,1130,1088,1055,1031,1024,1034,1074,1169,1860,4096
    };
    U16 lsc_tmpgb[] = {
    4096,3592,3075,2746,2514,2331,2223,2120,2052,2013,1992,1989,2035,2151,2502,4096,4096,
    4059,3174,2775,2518,2302,2126,2016,1927,1867,1830,1810,1814,1844,1919,2080,2941,4096,
    3563,2889,2538,2297,2102,1958,1848,1768,1708,1676,1662,1669,1698,1748,1864,2208,4096,
    3192,2710,2387,2130,1937,1810,1712,1643,1588,1554,1537,1548,1574,1625,1713,1928,3490,
    2928,2534,2254,2007,1825,1694,1595,1530,1489,1461,1438,1444,1470,1524,1603,1757,2575,
    2757,2398,2111,1886,1725,1599,1509,1443,1399,1370,1360,1362,1381,1430,1508,1635,2102,
    2618,2280,2000,1780,1631,1521,1435,1375,1331,1299,1293,1295,1313,1352,1427,1538,1867,
    2514,2181,1910,1698,1554,1450,1374,1317,1275,1248,1236,1237,1257,1292,1352,1458,1730,
    2417,2091,1832,1632,1496,1391,1316,1260,1225,1202,1190,1189,1205,1241,1298,1389,1649,
    2312,2008,1762,1571,1443,1343,1272,1217,1183,1163,1149,1150,1164,1195,1251,1336,1576,
    2243,1948,1711,1522,1398,1301,1231,1185,1151,1126,1115,1118,1130,1158,1204,1288,1534,
    2201,1898,1674,1488,1365,1270,1199,1156,1121,1100,1087,1087,1101,1127,1167,1245,1555,
    2170,1861,1640,1463,1341,1250,1182,1133,1099,1079,1067,1065,1077,1103,1144,1219,1633,
    2160,1850,1629,1454,1321,1231,1167,1120,1087,1065,1052,1050,1059,1082,1125,1215,1891,
    2216,1856,1628,1460,1321,1228,1159,1112,1076,1056,1041,1039,1045,1061,1107,1242,2724,
    2350,1873,1631,1466,1340,1240,1162,1112,1074,1050,1032,1027,1033,1055,1116,1366,4096,
    2993,1971,1673,1494,1368,1272,1187,1130,1088,1055,1031,1024,1034,1074,1169,1860,4096
    };
    U16 lsc_tmpb[] = {
    4096,3457,2989,2737,2547,2398,2303,2220,2162,2105,2080,2073,2086,2180,2518,4096,4096,
    3843,3023,2710,2514,2371,2227,2150,2073,2032,1979,1950,1940,1935,1971,2094,2939,4096,
    3353,2776,2504,2323,2192,2109,2038,1969,1916,1881,1852,1838,1820,1830,1894,2196,4096,
    3007,2608,2362,2189,2074,2004,1949,1903,1851,1811,1766,1745,1728,1723,1758,1920,3493,
    2734,2434,2239,2084,2000,1917,1868,1816,1786,1748,1702,1669,1639,1634,1642,1747,2501,
    2575,2299,2107,1967,1903,1842,1807,1754,1711,1680,1645,1601,1560,1544,1553,1615,2016,
    2422,2170,1995,1868,1813,1774,1737,1697,1656,1615,1587,1542,1503,1466,1468,1514,1775,
    2314,2068,1903,1777,1733,1692,1672,1640,1604,1564,1526,1483,1441,1406,1387,1437,1637,
    2215,1989,1827,1711,1666,1634,1610,1573,1543,1515,1472,1431,1388,1348,1338,1364,1562,
    2128,1907,1742,1638,1598,1567,1545,1513,1491,1455,1421,1382,1335,1297,1288,1308,1488,
    2066,1846,1686,1579,1541,1507,1484,1460,1430,1398,1365,1332,1289,1253,1238,1261,1455,
    2009,1798,1647,1537,1483,1448,1418,1396,1369,1343,1312,1277,1242,1211,1189,1220,1470,
    1974,1752,1603,1496,1435,1396,1362,1332,1303,1282,1253,1223,1195,1171,1162,1193,1539,
    1975,1739,1580,1460,1384,1336,1306,1271,1245,1220,1193,1169,1148,1129,1129,1188,1773,
    2030,1730,1557,1438,1346,1285,1242,1209,1180,1162,1138,1118,1100,1085,1100,1201,2557,
    2153,1733,1538,1421,1333,1256,1196,1157,1129,1107,1087,1070,1059,1057,1094,1301,4096,
    2752,1810,1551,1409,1314,1238,1170,1119,1086,1059,1035,1024,1024,1046,1122,1746,4096
    };
#endif

    cfg->isp_gain = 1024 * 1.34;

    cfg->gic_str = 0.8;
    cfg->gic_thd = 1.25;
     
    cfg->r_gain = 1024 * 1.11;
    cfg->g_gain = 1024 * 1;
    cfg->b_gain = 1024 * 1.27;


    cfg->ltm_r = 20;
    cfg->ltm_str = 1.3;
    cfg->ltm_gain_limit_max = 2;
    cfg->ltm_gain_limit_min = 0.0;


    float ccm_tmp[9] = {
1.19, 0.12, -0.42,
-0.22, 1.64, -0.59,
0.04, -0.76, 2.00
    };




    cfg->defog_smp_ratio = 4;
    cfg->light_ratio = 1.0;
    cfg->defog_str = 0.15;

    U32 gamma_xtmp[GAMMA_LENGTH] =
    {
        0,1,2,3,4,5,6,7,8,10,12,14,16,20,24,28,32,40,48,56,64,80,96,112,128,160,192,224,256,320,384,448,512,640,768,896,1024,1280,1536,1792,2048,2304,2560,2816,3072,3328,3584,3840,4095
    };

    U32 gamma_ytmp[GAMMA_LENGTH] =
    {
        0,6,11,17,22,28,33,39,44,55,66,77,88,109,130,150,170,210,248,286,323,393,460,525,586,702,809,909,1002,1172,1323,1461,1587,1810,2003,2173,2325,2589,2812,3010,3191,3355,3499,3624,3736,3836,3927,4012,4095
    };

    cfg->ynr_r = 1;
    cfg->cnr_r = 3;

    cfg->txi_r_detail = 1;
    cfg->txi_r_bifilter = 1;
    cfg->txi_str = 20;

    //以下后处理
    U16 lsc_blk = cfg->lsc_wblock * cfg->lsc_hblock;
    cfg->lsc_rgain = (U16*)malloc(sizeof(U16) * lsc_blk);
    cfg->lsc_bgain = (U16*)malloc(sizeof(U16) * lsc_blk);
    cfg->lsc_grgain = (U16*)malloc(sizeof(U16) * lsc_blk);
    cfg->lsc_gbgain = (U16*)malloc(sizeof(U16) * lsc_blk);

    memcpy(cfg->lsc_rgain, lsc_tmpr, sizeof(U16) * lsc_blk);
    memcpy(cfg->lsc_bgain, lsc_tmpb, sizeof(U16) * lsc_blk);
    memcpy(cfg->lsc_grgain, lsc_tmpgr, sizeof(U16) * lsc_blk);
    memcpy(cfg->lsc_gbgain, lsc_tmpgb, sizeof(U16) * lsc_blk);

    if (cfg->awb_on == 0)
    {
        cfg->r_gain = 1024;
        cfg->g_gain = 1024;
        cfg->b_gain = 1024;
    }
    if (cfg->ccm_on == 1)
    {
        memcpy(cfg->ccm, ccm_tmp, 9 * sizeof(float));
    }
    else 
    {
        // 如果不启用CCM，则设置为单位矩阵
        cfg->ccm[0] = 1.0f; cfg->ccm[1] = 0.0f; cfg->ccm[2] = 0.0f;
        cfg->ccm[3] = 0.0f; cfg->ccm[4] = 1.0f; cfg->ccm[5] = 0.0f;
        cfg->ccm[6] = 0.0f; cfg->ccm[7] = 0.0f; cfg->ccm[8] = 1.0f;
    }
    calc_NAI((float)cfg->r_gain / 1024, (float)cfg->g_gain / 1024,
        (float)cfg->b_gain / 1024, cfg->ccm);
   
    if (cfg->rgb_bit > 12)
    {
        U8 shift = cfg->rgb_bit - 12;
        for (int i = 0; i < GAMMA_LENGTH; i++)
        {
            cfg->gamma_x[i] = gamma_xtmp[i] << shift;
            cfg->gamma_y[i] = gamma_ytmp[i] << shift;
        }
    }
    else if (cfg->rgb_bit < 12)
    {
        U8 shift = 12 - cfg->rgb_bit;
        for (int i = 0; i < GAMMA_LENGTH; i++)
        {
            cfg->gamma_x[i] = gamma_xtmp[i] >> shift;
            cfg->gamma_y[i] = gamma_ytmp[i] >> shift;
        }
    }

    return;
}

void calc_NAI(float rg, float gg, float bg, float* ccm)
{
    float nai[3] = { 0 };

  

    // 增益平方
    float gains[3] = {
        rg * rg,
        gg * gg,
        bg * bg
    };

    // 计算每个输出通道的NAI
    for (int out_c = 0; out_c < 3; ++out_c) {
        for (int in_c = 0; in_c < 3; ++in_c) {
            float coeff = ccm[out_c * 3 + in_c];  // 行主序访问
            nai[out_c] += coeff * coeff * gains[in_c];
        }
    }

    LOG("NAI = [%.2f, %.2f, %.2f]\n", nai[0], nai[1], nai[2]);
}

// 从 INI 文件加载配置
void load_cfg_from_ini(const char* filename, G_CONFIG* cfg) {
    FILE* f = fopen(filename, "r");
    if (!f) {
        perror("fopen");
        return;
    }
    // 初始化默认值
    memset(cfg, 0, sizeof(*cfg));
    cfg->order = LITTLE_ENDIAN;
    cfg->pattern = BGGR;
    cfg->lsc_rgain = NULL;

    char line[256], section[64] = { 0 };
    while (fgets(line, sizeof(line), f)) {
        char* p = trim(line);
        if (*p == 0 || *p == ';') continue;
        if (*p == '[') {
            char* end = strchr(p, ']');
            if (end) {
                size_t len = end - p - 1;
                strncpy(section, p + 1, len);
                section[len] = '\0';
            }
            continue;
        }
        char* eq = strchr(p, '=');
        if (!eq) continue;
        *eq = '\0';
        char* key = trim(p), * val = trim(eq + 1);

        if (strcmp(section, "raw_param") == 0) {
            if (strcmp(key, "bit") == 0) cfg->bit = (U8)strtoul(val, NULL, 0);
            else if (strcmp(key, "used_bit") == 0) cfg->used_bit = (U8)strtoul(val, NULL, 0);
            else if (strcmp(key, "order") == 0) cfg->order = parse_order(val);
            else if (strcmp(key, "pattern") == 0) cfg->pattern = parse_pattern(val);
        }
        else if (strcmp(section, "module_on") == 0) {
            if (strcmp(key, "ob_on") == 0) cfg->ob_on = (U8)strtoul(val, NULL, 0);
            else if (strcmp(key, "lsc_on") == 0) cfg->lsc_on = (U8)strtoul(val, NULL, 0);
        }
        else if (strcmp(section, "ob") == 0) {
            if (strcmp(key, "ob") == 0) cfg->ob = (U16)(eval_simple_expr(val) + 0.5);
        }
        else if (strcmp(section, "lsc") == 0) {
            if (strcmp(key, "lsc_rgain") == 0) parse_u16_array(val, &cfg->lsc_rgain);
        }
        else if (strcmp(section, "awb") == 0) {
            if (strcmp(key, "r_gain") == 0) cfg->r_gain = (U16)(eval_simple_expr(val) + 0.5);
        }
        else if (strcmp(section, "ccm") == 0) {
            if (strcmp(key, "ccm") == 0) parse_float_array9(val, cfg->ccm);
        }
    }
    fclose(f);
}

// 去除首尾空白
static char* trim(char* s) {
    char* end;
    while (isspace((unsigned char)*s)) s++;
    if (*s == 0) return s;
    end = s + strlen(s) - 1;
    while (end > s && isspace((unsigned char)*end)) end--;
    *(end + 1) = 0;
    return s;
}

// 解析字节顺序
static ByteOrder parse_order(const char* s) {
    return (strcasecmp(s, "BIG_ENDIAN") == 0) ? BIG_ENDIAN : LITTLE_ENDIAN;
}

// 解析 Bayer 格式
static BayerPattern parse_pattern(const char* s) {
    if (strcasecmp(s, "RGGB") == 0) return RGGB;
    else if (strcasecmp(s, "GRBG") == 0) return GRBG;
    else if (strcasecmp(s, "GBRG") == 0) return GBRG;
    else                                   return BGGR;
}

// 计算简单表达式：支持 a 或 a*b
static double eval_simple_expr(const char* s) {
    char* star = (char*)malloc(strlen(s) + 1);
    strcpy(star, s);
    if (!star) {
        return strtod(s, NULL);
    }
    else {
        double a = strtod(s, NULL);
        double b = strtod(star + 1, NULL);
        return a * b;
    }
}

// 解析 U16 数组，返回元素个数
static int parse_u16_array(const char* s, U16** out) {
    // 定位到 '[' 并跳过
    while (*s && *s != '[') s++;
    if (*s == '[') s++;
    size_t cap = 4, cnt = 0;
    U16* arr = (U16*)malloc(cap * sizeof(U16));
    char* copy = strdup(s);
    char* rb = strchr(copy, ']');
    if (rb) *rb = '\0';

    char* tok = strtok(copy, ",");
    while (tok) {
        double v = eval_simple_expr(trim(tok));
        if (cnt >= cap) {
            cap *= 2;
            arr = (U16*)realloc(arr, cap * sizeof(U16));
        }
        arr[cnt++] = (U16)(v + 0.5);
        tok = strtok(NULL, ",");
    }

    free(copy);
    *out = arr;
    return (int)cnt;
}

// 解析 9 元素 float 数组
static void parse_float_array9(const char* s, float out[9]) {
    while (*s && *s != '[') s++;
    if (*s == '[') s++;
    char* copy = strdup(s);
    char* rb = strchr(copy, ']');
    if (rb) *rb = '\0';

    int idx = 0;
    char* tok = strtok(copy, ",");
    while (tok && idx < 9) {
        out[idx++] = (float)eval_simple_expr(trim(tok));
        tok = strtok(NULL, ",");
    }

    free(copy);
}
