#pragma once

#include "load_ini.h"

#define strcasecmp _stricmp 

void load_cfg(G_CONFIG* cfg)
{
    cfg->bit = 16;
    cfg->used_bit = 10;
    cfg->order = LITTLE_ENDIAN;
    cfg->pattern = BGGR;
    cfg->width = 1440;
    cfg->height = 1048;

    cfg->rgb_bit = 16;
    cfg->yuv_bit = 16;

    cfg->ob_on = 1;
    cfg->lsc_on = 1;
    cfg->gic_on = 1;
    cfg->isp_gain_on = 0;
    cfg->awb_on = 1;
    cfg->ltm_on = 0;
    cfg->ccm_on = 1;
    cfg->rgbgamma_on = 1;
    cfg->defog_on = 0;
    //cfg->ygamma_on = 0;
    cfg->sharp_on = 0;
    cfg->ynr_on = 1;
    cfg->cnr_on = 1;
    cfg->yuv_txi_on = 1;

    //12->16bit
    cfg->ob = 64 * 16;


    cfg->lsc_type = 0; //0为插值
    cfg->lsc_wblock = 17;
    cfg->lsc_hblock = 17;
    cfg->luma_str = 0.0;
    cfg->lsc_max_gain = 4096;
    cfg->lsc_gic_on = 1;
#if 1
    U16 lsc_tmpr[] = {
    1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,
    1024,1024,1024,1024,1024,1024,1024,1040,1072,1079,1063,1036,1024,1024,1024,1024,1024,
    1024,1024,1024,1024,1024,1048,1135,1202,1244,1254,1229,1170,1103,1024,1024,1024,1024,
    1024,1024,1024,1024,1040,1165,1294,1397,1463,1472,1427,1336,1226,1110,1024,1024,1024,
    1024,1024,1024,1024,1127,1297,1472,1616,1700,1715,1649,1524,1356,1196,1064,1024,1024,
    1024,1024,1024,1042,1201,1409,1640,1832,1938,1955,1868,1706,1481,1273,1109,1024,1024,
    1024,1024,1024,1078,1262,1509,1781,1996,2124,2150,2042,1835,1575,1335,1152,1024,1024,
    1024,1024,1024,1100,1300,1562,1859,2111,2248,2266,2148,1916,1636,1365,1166,1026,1024,
    1024,1024,1024,1106,1309,1592,1890,2150,2289,2309,2192,1950,1662,1380,1168,1037,1024,
    1024,1024,1024,1101,1308,1589,1894,2133,2276,2275,2160,1932,1648,1376,1178,1031,1024,
    1024,1024,1024,1087,1284,1544,1831,2066,2192,2190,2086,1879,1605,1351,1160,1024,1024,
    1024,1024,1024,1061,1232,1460,1698,1906,2019,2020,1933,1750,1527,1295,1130,1024,1024,
    1024,1024,1024,1024,1169,1352,1554,1716,1805,1800,1738,1601,1418,1235,1091,1024,1024,
    1024,1024,1024,1024,1088,1232,1374,1502,1565,1572,1528,1427,1297,1156,1047,1024,1024,
    1024,1024,1024,1024,1024,1116,1215,1301,1342,1346,1322,1262,1171,1072,1024,1024,1024,
    1024,1024,1024,1024,1024,1024,1078,1136,1166,1160,1151,1108,1048,1024,1024,1024,1024,
    1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024
    };
    U16 lsc_tmpgr[] = {
    1552,1494,1465,1407,1331,1262,1199,1155,1136,1119,1130,1160,1197,1250,1316,1381,1543,
    1517,1486,1432,1354,1255,1159,1081,1050,1047,1048,1052,1063,1104,1177,1260,1337,1490,
    1505,1463,1393,1290,1167,1080,1070,1062,1059,1062,1069,1074,1088,1102,1207,1308,1421,
    1502,1439,1354,1230,1108,1092,1082,1074,1072,1074,1079,1085,1100,1115,1144,1267,1366,
    1494,1419,1317,1172,1118,1101,1090,1085,1081,1083,1089,1096,1108,1124,1143,1234,1341,
    1484,1410,1285,1149,1127,1108,1098,1090,1089,1090,1094,1104,1115,1133,1152,1208,1319,
    1485,1397,1261,1155,1133,1115,1102,1095,1094,1094,1100,1108,1121,1139,1159,1189,1332,
    1497,1400,1254,1161,1138,1118,1105,1099,1096,1097,1103,1111,1123,1143,1164,1184,1319,
    1505,1397,1249,1163,1139,1121,1106,1101,1097,1098,1102,1112,1126,1145,1166,1189,1321,
    1506,1396,1250,1161,1137,1118,1106,1098,1095,1096,1101,1110,1124,1144,1165,1186,1314,
    1504,1399,1251,1156,1133,1113,1101,1094,1092,1093,1097,1107,1120,1139,1162,1188,1318,
    1501,1408,1270,1150,1126,1108,1096,1088,1084,1086,1092,1101,1114,1133,1155,1197,1315,
    1499,1418,1292,1146,1121,1101,1089,1082,1080,1080,1085,1094,1107,1125,1145,1208,1287,
    1500,1436,1325,1191,1111,1092,1078,1072,1068,1070,1075,1085,1097,1115,1136,1234,1257,
    1495,1438,1348,1237,1108,1081,1068,1060,1056,1056,1062,1071,1085,1102,1160,1244,1247,
    1504,1449,1374,1291,1183,1086,1053,1045,1040,1041,1048,1057,1069,1129,1213,1249,1344,
    1557,1460,1409,1346,1260,1185,1107,1055,1024,1034,1052,1099,1143,1200,1255,1223,1447
    };
    U16 lsc_tmpgb[] = {
    1552,1494,1465,1407,1331,1262,1199,1155,1136,1119,1130,1160,1197,1250,1316,1381,1543,
    1517,1486,1432,1354,1255,1159,1081,1050,1047,1048,1052,1063,1104,1177,1260,1337,1490,
    1505,1463,1393,1290,1167,1080,1070,1062,1059,1062,1069,1074,1088,1102,1207,1308,1421,
    1502,1439,1354,1230,1108,1092,1082,1074,1072,1074,1079,1085,1100,1115,1144,1267,1366,
    1494,1419,1317,1172,1118,1101,1090,1085,1081,1083,1089,1096,1108,1124,1143,1234,1341,
    1484,1410,1285,1149,1127,1108,1098,1090,1089,1090,1094,1104,1115,1133,1152,1208,1319,
    1485,1397,1261,1155,1133,1115,1102,1095,1094,1094,1100,1108,1121,1139,1159,1189,1332,
    1497,1400,1254,1161,1138,1118,1105,1099,1096,1097,1103,1111,1123,1143,1164,1184,1319,
    1505,1397,1249,1163,1139,1121,1106,1101,1097,1098,1102,1112,1126,1145,1166,1189,1321,
    1506,1396,1250,1161,1137,1118,1106,1098,1095,1096,1101,1110,1124,1144,1165,1186,1314,
    1504,1399,1251,1156,1133,1113,1101,1094,1092,1093,1097,1107,1120,1139,1162,1188,1318,
    1501,1408,1270,1150,1126,1108,1096,1088,1084,1086,1092,1101,1114,1133,1155,1197,1315,
    1499,1418,1292,1146,1121,1101,1089,1082,1080,1080,1085,1094,1107,1125,1145,1208,1287,
    1500,1436,1325,1191,1111,1092,1078,1072,1068,1070,1075,1085,1097,1115,1136,1234,1257,
    1495,1438,1348,1237,1108,1081,1068,1060,1056,1056,1062,1071,1085,1102,1160,1244,1247,
    1504,1449,1374,1291,1183,1086,1053,1045,1040,1041,1048,1057,1069,1129,1213,1249,1344,
    1557,1460,1409,1346,1260,1185,1107,1055,1024,1034,1052,1099,1143,1200,1255,1223,1447
    };
    U16 lsc_tmpb[] = {
    1390,1450,1440,1402,1339,1271,1211,1162,1140,1119,1128,1158,1189,1239,1277,1327,1596,
    1442,1444,1422,1361,1276,1187,1109,1072,1068,1068,1067,1074,1114,1175,1239,1266,1528,
    1441,1432,1389,1312,1203,1124,1115,1109,1101,1099,1103,1103,1108,1110,1197,1255,1355,
    1442,1419,1361,1258,1153,1151,1149,1139,1132,1130,1131,1128,1134,1132,1145,1233,1287,
    1442,1404,1325,1205,1171,1173,1169,1167,1157,1154,1154,1151,1148,1149,1141,1201,1261,
    1435,1387,1289,1179,1182,1182,1185,1176,1171,1166,1161,1164,1159,1152,1145,1168,1238,
    1431,1369,1267,1188,1193,1199,1198,1193,1188,1180,1178,1176,1170,1164,1156,1152,1252,
    1439,1374,1257,1193,1198,1204,1208,1202,1193,1188,1186,1182,1175,1172,1164,1153,1244,
    1431,1359,1244,1185,1192,1200,1201,1199,1192,1187,1183,1177,1174,1168,1159,1150,1234,
    1431,1358,1244,1183,1189,1198,1204,1198,1191,1187,1185,1180,1173,1168,1159,1145,1236,
    1428,1362,1247,1180,1186,1192,1197,1195,1190,1184,1178,1177,1169,1165,1159,1149,1238,
    1427,1373,1268,1174,1177,1180,1184,1180,1178,1175,1170,1171,1162,1157,1149,1156,1246,
    1425,1380,1288,1164,1164,1164,1164,1160,1157,1154,1155,1157,1149,1145,1139,1164,1260,
    1425,1392,1314,1204,1143,1138,1131,1127,1119,1122,1127,1132,1134,1130,1124,1186,1303,
    1426,1404,1343,1254,1139,1121,1108,1095,1088,1092,1103,1112,1118,1114,1149,1202,1394,
    1413,1406,1360,1297,1205,1110,1071,1059,1051,1056,1068,1081,1086,1131,1189,1242,1463,
    1391,1398,1378,1335,1264,1194,1114,1061,1024,1035,1057,1097,1138,1179,1208,1400,1425
    };
#endif

    cfg->isp_gain = 1024 * 0.8;

    cfg->gic_str = 0.8;
    cfg->gic_thd = 1.25;
     
    cfg->r_gain = 1024 * 1.94;
    cfg->g_gain = 1024 * 1; 
    cfg->b_gain = 1024 * 1.34;


    cfg->ltm_r = 20;
    cfg->ltm_str = 1.3;
    cfg->ltm_gain_limit_max = 2;
    cfg->ltm_gain_limit_min = 0.0;


    float ccm_tmp[9] = {
0.51, 1.46, -0.89,
0.13, -0.22, 1.09,
0.36, -0.25, 0.80

    };




    cfg->defog_smp_ratio = 4;
    cfg->light_ratio = 1.0;
    cfg->defog_str = 0.15;

    U32 gamma_xtmp[GAMMA_LENGTH] =
    {
        0,1,2,3,4,5,6,7,8,10,12,14,16,20,24,28,32,40,48,56,64,80,96,112,128,160,192,224,256,320,384,448,512,640,768,896,1024,1280,1536,1792,2048,2304,2560,2816,3072,3328,3584,3840,4095
    };

    U32 gamma_ytmp[GAMMA_LENGTH] =
    {
        0,6,11,17,22,28,33,39,44,55,66,77,88,109,130,150,170,210,248,286,323,393,460,525,586,702,809,909,1002,1172,1323,1461,1587,1810,2003,2173,2325,2589,2812,3010,3191,3355,3499,3624,3736,3836,3927,4012,4095
    };

    cfg->ynr_r = 1;
    cfg->cnr_r = 3;

    cfg->txi_r_detail = 1;
    cfg->txi_r_bifilter = 1;
    cfg->txi_str = 20;



    //以下后处理
    U16 lsc_blk = cfg->lsc_wblock * cfg->lsc_hblock;
    cfg->lsc_rgain = (U16*)malloc(sizeof(U16) * lsc_blk);
    cfg->lsc_bgain = (U16*)malloc(sizeof(U16) * lsc_blk);
    cfg->lsc_grgain = (U16*)malloc(sizeof(U16) * lsc_blk);
    cfg->lsc_gbgain = (U16*)malloc(sizeof(U16) * lsc_blk);

    memcpy(cfg->lsc_rgain, lsc_tmpr, sizeof(U16) * lsc_blk);
    memcpy(cfg->lsc_bgain, lsc_tmpb, sizeof(U16) * lsc_blk);
    memcpy(cfg->lsc_grgain, lsc_tmpgr, sizeof(U16) * lsc_blk);
    memcpy(cfg->lsc_gbgain, lsc_tmpgb, sizeof(U16) * lsc_blk);

    if (cfg->awb_on == 0)
    {
        cfg->r_gain = 1024;
        cfg->g_gain = 1024;
        cfg->b_gain = 1024;
    }
    if (cfg->ccm_on == 1)
    {
        memcpy(cfg->ccm, ccm_tmp, 9 * sizeof(float));
    }
    else 
    {
        // 如果不启用CCM，则设置为单位矩阵
        cfg->ccm[0] = 1.0f; cfg->ccm[1] = 0.0f; cfg->ccm[2] = 0.0f;
        cfg->ccm[3] = 0.0f; cfg->ccm[4] = 1.0f; cfg->ccm[5] = 0.0f;
        cfg->ccm[6] = 0.0f; cfg->ccm[7] = 0.0f; cfg->ccm[8] = 1.0f;
    }
    calc_NAI((float)cfg->r_gain / 1024, (float)cfg->g_gain / 1024,
        (float)cfg->b_gain / 1024, cfg->ccm);
   
    if (cfg->rgb_bit > 12)
    {
        U8 shift = cfg->rgb_bit - 12;
        for (int i = 0; i < GAMMA_LENGTH; i++)
        {
            cfg->gamma_x[i] = gamma_xtmp[i] << shift;
            cfg->gamma_y[i] = gamma_ytmp[i] << shift;
        }
    }
    else if (cfg->rgb_bit < 12)
    {
        U8 shift = 12 - cfg->rgb_bit;
        for (int i = 0; i < GAMMA_LENGTH; i++)
        {
            cfg->gamma_x[i] = gamma_xtmp[i] >> shift;
            cfg->gamma_y[i] = gamma_ytmp[i] >> shift;
        }
    }

    return;
}

void calc_NAI(float rg, float gg, float bg, float* ccm)
{
    float nai[3] = { 0 };

  

    // 增益平方
    float gains[3] = {
        rg * rg,
        gg * gg,
        bg * bg
    };

    // 计算每个输出通道的NAI
    for (int out_c = 0; out_c < 3; ++out_c) {
        for (int in_c = 0; in_c < 3; ++in_c) {
            float coeff = ccm[out_c * 3 + in_c];  // 行主序访问
            nai[out_c] += coeff * coeff * gains[in_c];
        }
    }

    LOG("NAI = [%.2f, %.2f, %.2f]\n", nai[0], nai[1], nai[2]);
}

// 从 INI 文件加载配置
void load_cfg_from_ini(const char* filename, G_CONFIG* cfg) {
    FILE* f = fopen(filename, "r");
    if (!f) {
        perror("fopen");
        return;
    }
    // 初始化默认值
    memset(cfg, 0, sizeof(*cfg));
    cfg->order = LITTLE_ENDIAN;
    cfg->pattern = BGGR;
    cfg->lsc_rgain = NULL;

    char line[256], section[64] = { 0 };
    while (fgets(line, sizeof(line), f)) {
        char* p = trim(line);
        if (*p == 0 || *p == ';') continue;
        if (*p == '[') {
            char* end = strchr(p, ']');
            if (end) {
                size_t len = end - p - 1;
                strncpy(section, p + 1, len);
                section[len] = '\0';
            }
            continue;
        }
        char* eq = strchr(p, '=');
        if (!eq) continue;
        *eq = '\0';
        char* key = trim(p), * val = trim(eq + 1);

        if (strcmp(section, "raw_param") == 0) {
            if (strcmp(key, "bit") == 0) cfg->bit = (U8)strtoul(val, NULL, 0);
            else if (strcmp(key, "used_bit") == 0) cfg->used_bit = (U8)strtoul(val, NULL, 0);
            else if (strcmp(key, "order") == 0) cfg->order = parse_order(val);
            else if (strcmp(key, "pattern") == 0) cfg->pattern = parse_pattern(val);
        }
        else if (strcmp(section, "module_on") == 0) {
            if (strcmp(key, "ob_on") == 0) cfg->ob_on = (U8)strtoul(val, NULL, 0);
            else if (strcmp(key, "lsc_on") == 0) cfg->lsc_on = (U8)strtoul(val, NULL, 0);
        }
        else if (strcmp(section, "ob") == 0) {
            if (strcmp(key, "ob") == 0) cfg->ob = (U16)(eval_simple_expr(val) + 0.5);
        }
        else if (strcmp(section, "lsc") == 0) {
            if (strcmp(key, "lsc_rgain") == 0) parse_u16_array(val, &cfg->lsc_rgain);
        }
        else if (strcmp(section, "awb") == 0) {
            if (strcmp(key, "r_gain") == 0) cfg->r_gain = (U16)(eval_simple_expr(val) + 0.5);
        }
        else if (strcmp(section, "ccm") == 0) {
            if (strcmp(key, "ccm") == 0) parse_float_array9(val, cfg->ccm);
        }
    }
    fclose(f);
}

// 去除首尾空白
static char* trim(char* s) {
    char* end;
    while (isspace((unsigned char)*s)) s++;
    if (*s == 0) return s;
    end = s + strlen(s) - 1;
    while (end > s && isspace((unsigned char)*end)) end--;
    *(end + 1) = 0;
    return s;
}

// 解析字节顺序
static ByteOrder parse_order(const char* s) {
    return (strcasecmp(s, "BIG_ENDIAN") == 0) ? BIG_ENDIAN : LITTLE_ENDIAN;
}

// 解析 Bayer 格式
static BayerPattern parse_pattern(const char* s) {
    if (strcasecmp(s, "RGGB") == 0) return RGGB;
    else if (strcasecmp(s, "GRBG") == 0) return GRBG;
    else if (strcasecmp(s, "GBRG") == 0) return GBRG;
    else                                   return BGGR;
}

// 计算简单表达式：支持 a 或 a*b
static double eval_simple_expr(const char* s) {
    char* star = (char*)malloc(strlen(s) + 1);
    strcpy(star, s);
    if (!star) {
        return strtod(s, NULL);
    }
    else {
        double a = strtod(s, NULL);
        double b = strtod(star + 1, NULL);
        return a * b;
    }
}

// 解析 U16 数组，返回元素个数
static int parse_u16_array(const char* s, U16** out) {
    // 定位到 '[' 并跳过
    while (*s && *s != '[') s++;
    if (*s == '[') s++;
    size_t cap = 4, cnt = 0;
    U16* arr = (U16*)malloc(cap * sizeof(U16));
    char* copy = strdup(s);
    char* rb = strchr(copy, ']');
    if (rb) *rb = '\0';

    char* tok = strtok(copy, ",");
    while (tok) {
        double v = eval_simple_expr(trim(tok));
        if (cnt >= cap) {
            cap *= 2;
            arr = (U16*)realloc(arr, cap * sizeof(U16));
        }
        arr[cnt++] = (U16)(v + 0.5);
        tok = strtok(NULL, ",");
    }

    free(copy);
    *out = arr;
    return (int)cnt;
}

// 解析 9 元素 float 数组
static void parse_float_array9(const char* s, float out[9]) {
    while (*s && *s != '[') s++;
    if (*s == '[') s++;
    char* copy = strdup(s);
    char* rb = strchr(copy, ']');
    if (rb) *rb = '\0';

    int idx = 0;
    char* tok = strtok(copy, ",");
    while (tok && idx < 9) {
        out[idx++] = (float)eval_simple_expr(trim(tok));
        tok = strtok(NULL, ",");
    }

    free(copy);
}
